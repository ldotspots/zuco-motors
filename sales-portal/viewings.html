<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Schedule - ZMNZ Sales Agent</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css">
  <style>
    .calendar-grid { display: grid; grid-template-columns: 80px repeat(7, 1fr); gap: 1px; background: var(--gray-200); border-radius: var(--radius-md); overflow: hidden; }
    .cal-header { background: var(--gray-100); padding: 0.75rem 0.5rem; text-align: center; font-weight: 600; font-size: var(--text-sm); }
    .cal-header.today { background: var(--primary-100); color: var(--primary-700); }
    .cal-time { background: var(--gray-50); padding: 0.5rem; font-size: var(--text-sm); color: var(--gray-600); display: flex; align-items: center; justify-content: center; }
    .cal-cell { background: white; padding: 0.25rem; min-height: 52px; display: flex; flex-direction: column; gap: 2px; }
    .cal-cell.past { background: var(--gray-50); }
    .cal-slot { border-radius: var(--radius-sm); padding: 0.25rem 0.4rem; font-size: 11px; line-height: 1.3; display: flex; flex-direction: column; justify-content: center; }
    .cal-slot .slot-label { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .cal-slot .slot-sub { font-size: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* Viewing — blue */
    .cal-slot.viewing { background: #dbeafe; border-left: 3px solid #3b82f6; }
    .cal-slot.viewing .slot-sub { color: #6b7280; }
    .cal-slot.viewing.approved { background: #dbeafe; border-left-color: #2563eb; }
    .cal-slot.viewing.rejected { background: var(--gray-100); border-left-color: var(--gray-400); opacity: 0.5; text-decoration: line-through; }
    .cal-slot.viewing.completed { background: #dbeafe; border-left-color: #1d4ed8; }
    .cal-slot.viewing.no_show { background: #fef2f2; border-left-color: var(--error); }

    /* Test Drive — green */
    .cal-slot.testdrive { background: #dcfce7; border-left: 3px solid #22c55e; }
    .cal-slot.testdrive .slot-sub { color: #6b7280; }
    .cal-slot.testdrive.cancelled { background: var(--gray-100); border-left-color: var(--gray-400); opacity: 0.5; text-decoration: line-through; }
    .cal-slot.testdrive.no-show { background: #fef2f2; border-left-color: var(--error); }

    /* Booking types via bookingType field */
    .cal-slot.test_drive { background: #dcfce7; border-left: 3px solid #22c55e; }
    .cal-slot.test_drive .slot-sub { color: #6b7280; }
    .cal-slot.consultation { background: #fef3c7; border-left: 3px solid #f59e0b; }
    .cal-slot.consultation .slot-sub { color: #6b7280; }

    /* Other agent — grey */
    .cal-slot.other { background: var(--gray-100); border-left: 3px solid var(--gray-400); color: var(--gray-500); }
    .cal-slot.other .slot-sub { color: var(--gray-400); }

    .week-nav { display: flex; align-items: center; gap: 1rem; }
    .week-nav button { background: none; border: 1px solid var(--gray-300); border-radius: var(--radius-sm); padding: 0.4rem 0.75rem; cursor: pointer; font-size: var(--text-sm); }
    .week-nav button:hover { background: var(--gray-100); }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <a href="index.html" class="logo"><img src="../css/images/zmnz (1).png" alt="ZMNZ Motors" style="height: 40px;"></a>
        <nav class="nav">
          <a href="index.html">Dashboard</a>
          <a href="vehicles.html">Browse Vehicles</a>
          <a href="my-vehicles.html">My Vehicles</a>
          <a href="viewings.html" class="active">Schedule</a>
          <a href="sales.html">Sales</a>
          <a href="profile.html">Profile</a>
          <button class="btn btn-secondary btn-sm" onclick="Auth.logout()">Logout</button>
        </nav>
      </div>
    </div>
  </header>

  <main class="section">
    <div class="container">
      <div class="flex justify-between items-center mb-8">
        <h1>Schedule</h1>
        <div class="week-nav">
          <button onclick="changeWeek(-1)">&larr; Prev Week</button>
          <button onclick="goToday()">Today</button>
          <span id="weekLabel" style="font-weight:600;min-width:200px;text-align:center;"></span>
          <button onclick="changeWeek(1)">Next Week &rarr;</button>
        </div>
      </div>
      <!-- Calendar -->
      <div class="card">
        <div class="card-body" style="padding:0;">
          <div id="calendar" class="calendar-grid"></div>
        </div>
      </div>

      <!-- Legend -->
      <div class="flex gap-4 mt-4" style="font-size:var(--text-sm);color:var(--gray-600);flex-wrap:wrap;">
        <span><span style="display:inline-block;width:12px;height:12px;background:#dbeafe;border-left:3px solid #3b82f6;border-radius:2px;margin-right:4px;"></span> Car Viewing</span>
        <span><span style="display:inline-block;width:12px;height:12px;background:#dcfce7;border-left:3px solid #22c55e;border-radius:2px;margin-right:4px;"></span> Test Drive</span>
        <span><span style="display:inline-block;width:12px;height:12px;background:#fef3c7;border-left:3px solid #f59e0b;border-radius:2px;margin-right:4px;"></span> Consultation</span>
        <span><span style="display:inline-block;width:12px;height:12px;background:var(--gray-100);border-left:3px solid var(--gray-400);border-radius:2px;margin-right:4px;"></span> Unavailable (Other Agent)</span>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <div class="footer-bottom">
        <p>&copy; 2024 ZMNZ Motors. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script src="../js/db.js"></script>
  <script src="../js/auth.js"></script>
  <script src="../js/utils.js"></script>
  <script>
    const agent = Auth.getCurrentUser();
    const SLOTS = ['09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00'];
    const DAY_NAMES = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

    let weekOffset = 0;

    function getWeekStart(offset) {
      const now = new Date();
      const day = now.getDay();
      return new Date(now.getFullYear(), now.getMonth(), now.getDate() - day + 1 + (offset * 7));
    }

    function formatDateKey(d) {
      return d.toISOString().split('T')[0];
    }

    function slotKey(time) {
      // Normalize 30-min test drive times to their hourly slot (e.g. 09:30 -> 09:00)
      return time.substring(0, 2) + ':00';
    }

    function changeWeek(dir) { weekOffset += dir; render(); }
    function goToday() { weekOffset = 0; render(); }

    function render() {
      const myViewings = DB.getViewingBookingsByAgent(agent?.id);
      const myTestDrives = DB.getTestDrivesByAgent(agent?.id);
      const allViewings = DB.getViewingBookings().filter(b => b.status === 'pending' || b.status === 'approved');
      const allTestDrives = DB.getTestDrives().filter(td => td.status === 'scheduled');

      const weekStart = getWeekStart(weekOffset);
      const days = [];
      for (let i = 0; i < 7; i++) {
        const d = new Date(weekStart);
        d.setDate(d.getDate() + i);
        days.push(d);
      }

      const todayKey = formatDateKey(new Date());
      const weekEndDate = days[6];
      const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      document.getElementById('weekLabel').textContent =
        `${days[0].getDate()} ${monthNames[days[0].getMonth()]} — ${weekEndDate.getDate()} ${monthNames[weekEndDate.getMonth()]} ${weekEndDate.getFullYear()}`;

      const viewingStatusLabel = { pending: 'Pending', approved: 'Approved', rejected: 'Rejected', completed: 'Completed', no_show: 'No-Show' };
      const now = new Date();

      let html = '<div class="cal-header"></div>';
      days.forEach(d => {
        const key = formatDateKey(d);
        html += `<div class="cal-header${key === todayKey ? ' today' : ''}">${DAY_NAMES[d.getDay()]}<br>${d.getDate()}</div>`;
      });

      SLOTS.forEach(slot => {
        html += `<div class="cal-time">${slot}</div>`;
        days.forEach(d => {
          const key = formatDateKey(d);
          const slotDate = new Date(d.getFullYear(), d.getMonth(), d.getDate(), parseInt(slot));
          const isPast = slotDate < now;
          let cells = [];

          // My booking in this slot
          const myViewing = myViewings.find(b => b.date === key && b.timeSlot === slot);
          if (myViewing) {
            const v = DB.getVehicle(myViewing.vehicleId);
            const bTypeClass = myViewing.bookingType || 'viewing';
            const bTypeLabel = { viewing: 'Car Viewing', test_drive: 'Test Drive', consultation: 'Consultation' };
            cells.push(`<div class="cal-slot ${bTypeClass} ${myViewing.status}">
              <span class="slot-label">${myViewing.customerName}</span>
              <span class="slot-sub">${v ? `${v.year} ${v.make} ${v.model}` : ''}</span>
              <span class="slot-sub">${bTypeLabel[bTypeClass] || 'Viewing'} — ${viewingStatusLabel[myViewing.status] || myViewing.status}</span>
            </div>`);
          }

          // My test drives in this hourly slot (could be :00 or :30)
          const myTDs = myTestDrives.filter(td => td.date === key && slotKey(td.time) === slot);
          myTDs.forEach(td => {
            const v = DB.getVehicle(td.vehicleId);
            cells.push(`<div class="cal-slot testdrive ${td.status}">
              <span class="slot-label">${td.clientName} (${td.time})</span>
              <span class="slot-sub">${v ? `${v.year} ${v.make} ${v.model}` : ''}</span>
              <span class="slot-sub">Test Drive</span>
            </div>`);
          });

          // Other agents' viewings (only if I don't have one here)
          if (!myViewing) {
            const otherViewing = allViewings.find(b => b.date === key && b.timeSlot === slot && b.agentId !== agent?.id);
            if (otherViewing) {
              cells.push(`<div class="cal-slot other">
                <span class="slot-label">${otherViewing.agentName}</span>
                <span class="slot-sub">Unavailable</span>
              </div>`);
            }
          }

          // Other agents' test drives
          if (myTDs.length === 0) {
            const otherTDs = allTestDrives.filter(td => td.date === key && slotKey(td.time) === slot && td.agentId !== agent?.id);
            if (otherTDs.length > 0) {
              cells.push(`<div class="cal-slot other">
                <span class="slot-label">${otherTDs[0].agentName}</span>
                <span class="slot-sub">Unavailable</span>
              </div>`);
            }
          }

          html += `<div class="cal-cell${isPast ? ' past' : ''}">${cells.join('')}</div>`;
        });
      });

      document.getElementById('calendar').innerHTML = html;
    }

    render();
  </script>
</body>
</html>
