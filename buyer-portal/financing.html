<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Financing - Zuco Motors</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .status-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: var(--radius-full); font-size: var(--text-xs); font-weight: 600; }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-approved { background: #dcfce7; color: #166534; }
    .status-rejected { background: #fee2e2; color: #991b1b; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <a href="../index.html" class="logo"><img src="../css/images/zmnz (1).png" alt="ZMNZ Motors" style="height: 40px;"></a>
        <nav class="nav" id="mainNav">
          <a href="../index.html">Home</a>
          <a href="../about-us.html">About Us</a>
          <a href="inventory.html">Find a Car</a>
          <a href="../sell-your-car.html">Sell Your Car</a>
          <a href="financing.html" class="active">Financing</a>
          <a href="compare.html">Compare</a>
          <a href="login.html" class="btn btn-primary btn-sm nav-logged-out">Sign In / Register</a>
          <a href="../sales-portal/login.html" class="btn btn-secondary btn-sm nav-logged-out">Sales Agent Login</a>
          <a href="favorites.html" class="nav-logged-in" style="display:none;">Favorites</a>
          <a href="profile.html" class="nav-logged-in" style="display:none;">My Account</a>
          <button class="btn btn-secondary btn-sm nav-logged-in" style="display:none;" onclick="Auth.logout()">Sign Out</button>
        </nav>
      </div>
    </div>
  </header>

  <main class="section">
    <div class="container" style="max-width: 700px;">
      <h1 class="mb-4">Financing Inquiry</h1>
      <p style="color: var(--gray-600);" class="mb-8">Submit your details and our team will review your application and get back to you with financing options.</p>

      <!-- Existing Applications -->
      <div id="existingApps" style="display:none;" class="mb-8"></div>

      <!-- Financing Form -->
      <div id="formSection">
        <form id="financingForm" class="card">
          <div class="card-body">
            <h3 class="mb-4">Your Details</h3>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div class="form-group">
                <label for="firstName">First Name</label>
                <input type="text" id="firstName" class="form-control" required>
              </div>
              <div class="form-group">
                <label for="lastName">Last Name</label>
                <input type="text" id="lastName" class="form-control" required>
              </div>
            </div>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" class="form-control" required>
              </div>
              <div class="form-group">
                <label for="phone">Phone</label>
                <input type="tel" id="phone" class="form-control" required>
              </div>
            </div>

            <h3 class="mb-4" style="margin-top: 1.5rem;">Vehicle & Financing</h3>

            <div class="form-group">
              <label for="vehicleInterest">Vehicle of Interest</label>
              <input type="text" id="vehicleInterest" class="form-control" placeholder="e.g. 2022 Toyota Corolla or any SUV under $30k">
            </div>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div class="form-group">
                <label for="estimatedBudget">Estimated Budget ($)</label>
                <input type="number" id="estimatedBudget" class="form-control" placeholder="e.g. 25000" min="0" step="500">
              </div>
              <div class="form-group">
                <label for="depositAmount">Deposit Available ($)</label>
                <input type="number" id="depositAmount" class="form-control" placeholder="e.g. 5000" min="0" step="500">
              </div>
            </div>

            <div class="form-group">
              <label for="employmentStatus">Employment Status</label>
              <select id="employmentStatus" class="form-control" required>
                <option value="">Select...</option>
                <option value="full-time">Full-Time Employed</option>
                <option value="part-time">Part-Time Employed</option>
                <option value="self-employed">Self-Employed</option>
                <option value="student">Student</option>
                <option value="other">Other</option>
              </select>
            </div>

            <div class="form-group">
              <label for="annualIncome">Approximate Annual Income ($)</label>
              <input type="number" id="annualIncome" class="form-control" placeholder="e.g. 55000" min="0" step="1000">
            </div>

            <div class="form-group">
              <label for="notes">Additional Notes</label>
              <textarea id="notes" class="form-control" rows="3" placeholder="Anything else you'd like us to know..."></textarea>
            </div>

            <div class="form-group" style="display:flex;align-items:center;gap:0.5rem;">
              <input type="checkbox" id="consent" required style="width:auto;">
              <label for="consent" style="margin-bottom:0;">I consent to Zuco Motors contacting me about financing options</label>
            </div>

            <button type="submit" class="btn btn-primary w-full btn-lg">Submit Financing Inquiry</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <div class="footer-bottom">
        <p>&copy; 2024 Zuco Motors. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script src="../js/supabase-config.js"></script>
  <script src="../js/db.js"></script>
  <script src="../js/auth.js"></script>
  <script src="../js/utils.js"></script>
  <script>
    // Auth-aware nav
    if (Auth.isAuthenticated() && Auth.hasRole('buyer')) {
      document.querySelectorAll('.nav-logged-out').forEach(el => el.style.display = 'none');
      document.querySelectorAll('.nav-logged-in').forEach(el => el.style.display = '');
    }

    const user = Auth.getCurrentUserSync();

    // Auto-fill from logged-in user
    if (user) {
      document.getElementById('firstName').value = user.firstName || '';
      document.getElementById('lastName').value = user.lastName || '';
      document.getElementById('email').value = user.email || '';
      document.getElementById('phone').value = user.phone || '';
    }

    // Pre-fill vehicle from URL params
    const params = Utils.getQueryParams();
    if (params.vehicle) document.getElementById('vehicleInterest').value = params.vehicle;
    if (params.price) document.getElementById('estimatedBudget').value = params.price;

    // Show existing applications
    async function renderExistingApps() {
      if (!user) return;
      const apps = await DB.getFinancingApplicationsByUser(user.id);
      if (!apps.length) return;

      const container = document.getElementById('existingApps');
      container.style.display = '';
      container.innerHTML = '<h3 class="mb-4">Your Financing Inquiries</h3>' +
        apps.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt)).map(app => `
          <div class="card mb-4">
            <div class="card-body">
              <div class="flex justify-between items-center mb-2">
                <strong>${app.vehicleInterest || 'General Inquiry'}</strong>
                <span class="status-badge status-${app.status}">${app.status.charAt(0).toUpperCase() + app.status.slice(1)}</span>
              </div>
              <div style="font-size:var(--text-sm);color:var(--gray-500);">
                Submitted ${Utils.formatRelativeTime(app.submittedAt)}
                ${app.estimatedBudget ? ' &middot; Budget: ' + Utils.formatCurrency(app.estimatedBudget) : ''}
              </div>
              ${app.dealerNotes ? '<div style="margin-top:0.75rem;padding:0.75rem;background:var(--gray-50);border-radius:var(--radius-md);font-size:var(--text-sm);"><strong>Response:</strong> ' + app.dealerNotes + '</div>' : ''}
              ${app.approvedLimit ? '<div style="margin-top:0.5rem;font-size:var(--text-sm);color:var(--success);font-weight:600;">Approved Limit: ' + Utils.formatCurrency(app.approvedLimit) + '</div>' : ''}
            </div>
          </div>
        `).join('');
    }

    // Submit form
    document.getElementById('financingForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const app = {
        id: 'FIN-' + Date.now(),
        userId: user ? user.id : null,
        firstName: document.getElementById('firstName').value.trim(),
        lastName: document.getElementById('lastName').value.trim(),
        email: document.getElementById('email').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        vehicleInterest: document.getElementById('vehicleInterest').value.trim(),
        estimatedBudget: parseFloat(document.getElementById('estimatedBudget').value) || null,
        depositAmount: parseFloat(document.getElementById('depositAmount').value) || null,
        employmentStatus: document.getElementById('employmentStatus').value,
        annualIncome: parseFloat(document.getElementById('annualIncome').value) || null,
        notes: document.getElementById('notes').value.trim(),
        status: 'pending',
        submittedAt: new Date().toISOString(),
        reviewedAt: null,
        reviewedBy: null,
        dealerNotes: '',
        approvedLimit: null
      };

      await DB.addFinancingApplication(app);
      Utils.showToast('Financing inquiry submitted! We\'ll be in touch soon.', 'success');
      document.getElementById('financingForm').reset();

      if (user) {
        document.getElementById('firstName').value = user.firstName || '';
        document.getElementById('lastName').value = user.lastName || '';
        document.getElementById('email').value = user.email || '';
        document.getElementById('phone').value = user.phone || '';
      }

      await renderExistingApps();
    });

    async function init() {
      await renderExistingApps();
      DB.subscribeToVehicles(() => renderExistingApps());
    }
    init();
  </script>
</body>
</html>
