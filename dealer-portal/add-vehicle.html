<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Vehicle - Zuco Motors Dealer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <a href="index.html" class="logo"><img src="../css/images/zmnz (1).png" alt="ZMNZ Motors" style="height: 40px;"></a>
        <nav class="nav">
          <a href="index.html">Dashboard</a>
          <a href="inventory.html">Inventory</a>
          <a href="leads.html">Leads</a>
          <a href="pricing.html">Pricing</a>
          <a href="sales-orders.html">Sales Orders</a>
          <a href="quote-requests.html">Quote Requests</a>
          <a href="customers.html">Customers</a>
          <a href="applications.html">Applications</a>
          <a href="financing-applications.html">Financing</a>
          <a href="analytics.html">Analytics</a>
          <a href="past-sales.html">Past Sales</a>
          <a href="profile.html">Profile</a>
          <button class="btn btn-secondary btn-sm" onclick="Auth.logout()">Logout</button>
        </nav>
      </div>
    </div>
  </header>

  <main class="section">
    <div class="container" style="max-width: 900px;">
      <div class="flex justify-between items-center mb-8">
        <h1>Add New Vehicle</h1>
        <a href="inventory.html" class="btn btn-secondary">Back to Inventory</a>
      </div>

      <!-- Plate Lookup -->
      <div class="card mb-6">
        <div class="card-header"><h3>Quick Add via Plate Lookup</h3></div>
        <div class="card-body">
          <p style="color: var(--gray-600); margin-bottom: 1rem;">Enter a NZ registration plate to auto-fill vehicle details from CarJam.</p>
          <div class="form-group" style="margin-bottom: 0.5rem;">
            <label for="plate">Registration Plate</label>
            <div style="display:flex;gap:0.5rem;">
              <input type="text" id="plate" class="form-control" placeholder="e.g. ABC123" style="text-transform:uppercase;flex:1;max-width:200px;font-weight:600;letter-spacing:1px;">
              <button type="button" id="lookupBtn" class="btn btn-primary" onclick="lookupPlate()">Look Up</button>
            </div>
            <div id="lookupStatus" style="font-size:var(--text-sm);margin-top:0.5rem;"></div>
          </div>

          <!-- Lookup result card -->
          <div id="lookupResult" style="display:none;" class="mt-4">
            <div class="card" style="background:var(--gray-50);border:1px solid var(--gray-200);">
              <div class="card-body" style="padding:1rem 1.25rem;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                  <strong id="lookupVehicle" style="font-size:var(--text-lg);"></strong>
                  <span class="badge badge-primary" id="lookupPlateDisplay"></span>
                </div>
                <div id="lookupDetails" style="font-size:var(--text-sm);color:var(--gray-600);display:grid;grid-template-columns:repeat(3,1fr);gap:0.25rem 1rem;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <form id="addVehicleForm">
        <!-- Basic Info -->
        <div class="card mb-6">
          <div class="card-header"><h3>Vehicle Information</h3></div>
          <div class="card-body">
            <div class="grid grid-3">
              <div class="form-group">
                <label for="year">Year *</label>
                <input type="number" id="year" class="form-control" required min="1990" max="2025" value="2024">
              </div>
              <div class="form-group">
                <label for="make">Make *</label>
                <input type="text" id="make" class="form-control" required placeholder="e.g. Toyota">
              </div>
              <div class="form-group">
                <label for="model">Model *</label>
                <input type="text" id="model" class="form-control" required placeholder="e.g. Camry">
              </div>
            </div>
            <div class="grid grid-3">
              <div class="form-group">
                <label for="trim">Trim</label>
                <input type="text" id="trim" class="form-control" placeholder="e.g. XSE">
              </div>
              <div class="form-group">
                <label for="bodyStyle">Body Style *</label>
                <select id="bodyStyle" class="form-control" required>
                  <option value="Sedan">Sedan</option>
                  <option value="SUV">SUV</option>
                  <option value="Truck">Truck</option>
                  <option value="Coupe">Coupe</option>
                  <option value="Hatchback">Hatchback</option>
                  <option value="Minivan">Minivan</option>
                  <option value="Wagon">Wagon</option>
                  <option value="Ute">Ute</option>
                </select>
              </div>
              <div class="form-group">
                <label for="condition">Condition *</label>
                <select id="condition" class="form-control" required>
                  <option value="New">New</option>
                  <option value="Certified Pre-Owned">Certified Pre-Owned</option>
                  <option value="Used">Used</option>
                </select>
              </div>
            </div>
            <div class="grid grid-2">
              <div class="form-group">
                <label for="vin">VIN</label>
                <input type="text" id="vin" class="form-control" placeholder="17-character VIN" maxlength="17">
              </div>
              <div class="form-group">
                <label for="mileage">Mileage (km) *</label>
                <input type="number" id="mileage" class="form-control" required min="0" value="0">
              </div>
            </div>
            <div class="grid grid-2">
              <div class="form-group">
                <label for="exteriorColor">Exterior Color</label>
                <input type="text" id="exteriorColor" class="form-control" placeholder="e.g. Black">
              </div>
              <div class="form-group">
                <label for="interiorColor">Interior Color</label>
                <input type="text" id="interiorColor" class="form-control" placeholder="e.g. Black Leather">
              </div>
            </div>
          </div>
        </div>

        <!-- Specs -->
        <div class="card mb-6">
          <div class="card-header"><h3>Specifications</h3></div>
          <div class="card-body">
            <div class="grid grid-3">
              <div class="form-group">
                <label for="engine">Engine</label>
                <input type="text" id="engine" class="form-control" placeholder="e.g. 2.5L I4">
              </div>
              <div class="form-group">
                <label for="transmission">Transmission</label>
                <select id="transmission" class="form-control">
                  <option value="Automatic">Automatic</option>
                  <option value="Manual">Manual</option>
                  <option value="CVT">CVT</option>
                  <option value="DSG">DSG</option>
                  <option value="Single-Speed">Single-Speed (EV)</option>
                </select>
              </div>
              <div class="form-group">
                <label for="drivetrain">Drivetrain</label>
                <select id="drivetrain" class="form-control">
                  <option value="FWD">FWD</option>
                  <option value="RWD">RWD</option>
                  <option value="AWD">AWD</option>
                  <option value="4WD">4WD</option>
                </select>
              </div>
            </div>
            <div class="grid grid-4">
              <div class="form-group">
                <label for="fuelType">Fuel Type</label>
                <select id="fuelType" class="form-control">
                  <option value="Gasoline">Petrol</option>
                  <option value="Diesel">Diesel</option>
                  <option value="Electric">Electric</option>
                  <option value="Hybrid">Hybrid</option>
                </select>
              </div>
              <div class="form-group">
                <label for="horsepower">Horsepower</label>
                <input type="number" id="horsepower" class="form-control" min="0" value="200">
              </div>
              <div class="form-group">
                <label for="mpgCity">MPG City</label>
                <input type="number" id="mpgCity" class="form-control" min="0" value="25">
              </div>
              <div class="form-group">
                <label for="mpgHighway">MPG Highway</label>
                <input type="number" id="mpgHighway" class="form-control" min="0" value="32">
              </div>
            </div>
          </div>
        </div>

        <!-- Pricing -->
        <div class="card mb-6">
          <div class="card-header"><h3>Pricing</h3></div>
          <div class="card-body">
            <div class="grid grid-3">
              <div class="form-group">
                <label for="invoiceCost">Invoice Cost ($) *</label>
                <input type="number" id="invoiceCost" class="form-control" required min="0" step="100">
              </div>
              <div class="form-group">
                <label for="msrp">MSRP ($)</label>
                <input type="number" id="msrp" class="form-control" min="0" step="100">
              </div>
              <div class="form-group">
                <label for="markup">Markup (%)</label>
                <input type="number" id="markup" class="form-control" min="0" max="30" step="0.5" value="10">
              </div>
            </div>
            <div class="grid grid-2">
              <div class="form-group">
                <label for="holdback">Holdback ($)</label>
                <input type="number" id="holdback" class="form-control" min="0" value="0">
              </div>
              <div class="form-group">
                <label for="incentives">Incentives ($)</label>
                <input type="number" id="incentives" class="form-control" min="0" value="0">
              </div>
            </div>
          </div>
        </div>

        <!-- Features -->
        <div class="card mb-6">
          <div class="card-header"><h3>Features</h3></div>
          <div class="card-body">
            <div class="form-group">
              <label for="features">Features (comma-separated)</label>
              <textarea id="features" class="form-control" rows="3" placeholder="Bluetooth, Backup Camera, Cruise Control, Apple CarPlay"></textarea>
            </div>
          </div>
        </div>

        <div class="flex gap-4">
          <button type="submit" class="btn btn-primary btn-lg">Add Vehicle</button>
          <a href="inventory.html" class="btn btn-secondary btn-lg">Cancel</a>
        </div>
      </form>
    </div>
  </main>

  <footer>
    <div class="container">
      <div class="footer-bottom">
        <p>&copy; 2024 Zuco Motors. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script src="../js/db.js"></script>
  <script src="../js/auth.js"></script>
  <script src="../js/utils.js"></script>
  <script>
    const dealer = Auth.getCurrentUser();

    // ── NZ Plate Lookup ──────────────────────────────────────────
    const MOCK_PLATES = {
      'ABC123': { make: 'Toyota', model: 'Corolla', submodel: 'GX', year: 2018, cc: 1798, fuel: 'petrol', colour: 'Silver', body: 'Hatchback', seats: 5, odometer: 72400, transmission: 'Automatic', vin: 'JTDKN3DU5J1234567' },
      'DEF456': { make: 'Mazda', model: 'CX-5', submodel: 'GSX', year: 2020, cc: 2488, fuel: 'petrol', colour: 'Soul Red', body: 'SUV', seats: 5, odometer: 45200, transmission: 'Automatic', vin: 'JM3KFBCM0L0123456' },
      'GHI789': { make: 'Honda', model: 'Jazz', submodel: 'RS', year: 2019, cc: 1498, fuel: 'petrol', colour: 'Blue', body: 'Hatchback', seats: 5, odometer: 58300, transmission: 'CVT', vin: 'JHMGK5H70KX012345' },
      'JKL012': { make: 'Hyundai', model: 'Tucson', submodel: 'Elite', year: 2021, cc: 1999, fuel: 'diesel', colour: 'White', body: 'SUV', seats: 5, odometer: 31000, transmission: 'Automatic', vin: 'KMHJ3814MU012345' },
      'MNO345': { make: 'Ford', model: 'Ranger', submodel: 'XLT', year: 2019, cc: 3198, fuel: 'diesel', colour: 'Black', body: 'Ute', seats: 5, odometer: 89500, transmission: 'Automatic', vin: 'MNAUMFF70LW012345' },
      'YZA567': { make: 'Toyota', model: 'Hilux', submodel: 'SR5', year: 2021, cc: 2755, fuel: 'diesel', colour: 'Graphite', body: 'Ute', seats: 5, odometer: 38700, transmission: 'Automatic', vin: 'MROFR22G5M1012345' },
      'KLM789': { make: 'Tesla', model: 'Model 3', submodel: 'Standard Range Plus', year: 2021, cc: 0, fuel: 'electric', colour: 'White', body: 'Sedan', seats: 5, odometer: 28500, transmission: 'Automatic', vin: '5YJ3E1EA7MF012345' },
      'NOP012': { make: 'Toyota', model: 'RAV4', submodel: 'GXL Hybrid', year: 2022, cc: 2487, fuel: 'hybrid', colour: 'Silver', body: 'SUV', seats: 5, odometer: 19800, transmission: 'CVT', vin: 'JTMW1RFV2ND012345' }
    };

    const CARJAM_PROXY = '/.netlify/functions/carjam';

    function parseCarJamResponse(data) {
      const section = data?.hidh || data?.message?.hidh || data?.idh || data?.message?.idh || {};
      const v = section?.vehicle || section || {};
      if (!v.make) return null;
      return {
        make: titleCase(v.make || ''),
        model: titleCase(v.model || ''),
        submodel: titleCase(v.submodel || ''),
        year: parseInt(v.year_of_manufacture) || 0,
        cc: parseInt(String(v.cc_rating).replace(/[^0-9]/g, '')) || 0,
        fuel: (v.fuel_type || '').toLowerCase(),
        colour: v.main_colour || '',
        body: v.body_style || '',
        seats: parseInt(v.no_of_seats) || 5,
        odometer: parseInt(String(v.latest_odometer_reading).replace(/[^0-9]/g, '')) || 0,
        transmission: v.transmission || '',
        vin: v.vin || ''
      };
    }

    function titleCase(str) {
      return str.toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
    }

    async function lookupPlate() {
      const plate = document.getElementById('plate').value.trim().toUpperCase().replace(/\s+/g, '');
      const statusEl = document.getElementById('lookupStatus');
      const resultEl = document.getElementById('lookupResult');

      if (!plate) {
        statusEl.innerHTML = '<span style="color:var(--error);">Please enter a plate number</span>';
        return;
      }

      statusEl.innerHTML = '<span style="color:var(--gray-500);">Looking up plate...</span>';
      document.getElementById('lookupBtn').disabled = true;

      let vehicleData = null;

      // Try CarJam API
      if (CARJAM_PROXY) {
        try {
          const res = await fetch(`${CARJAM_PROXY}?plate=${encodeURIComponent(plate)}`);
          if (res.ok) {
            const data = await res.json();
            if (!(data?.code && data?.code < 0)) {
              vehicleData = parseCarJamResponse(data);
            }
          }
        } catch (e) {
          console.warn('CarJam lookup failed, falling back to mock:', e.message);
        }
      }

      // Fall back to mock data
      if (!vehicleData) {
        await new Promise(r => setTimeout(r, 600));
        vehicleData = MOCK_PLATES[plate] || null;
      }

      document.getElementById('lookupBtn').disabled = false;

      if (!vehicleData) {
        statusEl.innerHTML = '<span style="color:var(--error);">Plate not found. Please enter vehicle details manually below.</span>';
        resultEl.style.display = 'none';
        return;
      }

      // Show result card
      statusEl.innerHTML = '<span style="color:var(--success);">Vehicle found! Details auto-filled below.</span>';
      document.getElementById('lookupPlateDisplay').textContent = plate;
      document.getElementById('lookupVehicle').textContent =
        `${vehicleData.year} ${vehicleData.make} ${vehicleData.model} ${vehicleData.submodel || ''}`.trim();
      document.getElementById('lookupDetails').innerHTML = [
        vehicleData.colour ? `<span>Colour: <strong>${vehicleData.colour}</strong></span>` : '',
        vehicleData.body ? `<span>Body: <strong>${vehicleData.body}</strong></span>` : '',
        vehicleData.cc ? `<span>Engine: <strong>${vehicleData.cc}cc</strong></span>` : '',
        vehicleData.fuel ? `<span>Fuel: <strong>${vehicleData.fuel.charAt(0).toUpperCase() + vehicleData.fuel.slice(1)}</strong></span>` : '',
        vehicleData.transmission ? `<span>Trans: <strong>${vehicleData.transmission}</strong></span>` : '',
        vehicleData.odometer ? `<span>Odo: <strong>${Utils.formatNumber(vehicleData.odometer)} km</strong></span>` : '',
      ].filter(Boolean).join('');
      resultEl.style.display = 'block';

      // Auto-fill form fields
      document.getElementById('year').value = vehicleData.year;
      document.getElementById('make').value = vehicleData.make;
      document.getElementById('model').value = vehicleData.model + (vehicleData.submodel ? ' ' + vehicleData.submodel : '');
      if (vehicleData.submodel) document.getElementById('trim').value = vehicleData.submodel;
      if (vehicleData.odometer) document.getElementById('mileage').value = vehicleData.odometer;
      if (vehicleData.colour) document.getElementById('exteriorColor').value = vehicleData.colour;
      if (vehicleData.vin) document.getElementById('vin').value = vehicleData.vin;
      if (vehicleData.cc) document.getElementById('engine').value = (vehicleData.cc / 1000).toFixed(1) + 'L';

      // Map body style
      const bodyMap = { 'Hatchback': 'Hatchback', 'SUV': 'SUV', 'Sedan': 'Sedan', 'Ute': 'Ute', 'Wagon': 'Wagon', 'Coupe': 'Coupe' };
      if (vehicleData.body && bodyMap[vehicleData.body]) {
        document.getElementById('bodyStyle').value = bodyMap[vehicleData.body];
      }

      // Map transmission
      const transMap = { 'Automatic': 'Automatic', 'Manual': 'Manual', 'CVT': 'CVT', 'DSG': 'DSG' };
      if (vehicleData.transmission && transMap[vehicleData.transmission]) {
        document.getElementById('transmission').value = transMap[vehicleData.transmission];
      }

      // Map fuel type
      const fuelMap = { 'petrol': 'Gasoline', 'diesel': 'Diesel', 'electric': 'Electric', 'hybrid': 'Hybrid' };
      if (vehicleData.fuel && fuelMap[vehicleData.fuel]) {
        document.getElementById('fuelType').value = fuelMap[vehicleData.fuel];
      }

      // Set condition to Used for looked-up vehicles
      document.getElementById('condition').value = 'Used';
    }

    // Allow Enter key to trigger lookup
    document.getElementById('plate').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        lookupPlate();
      }
    });

    document.getElementById('addVehicleForm').addEventListener('submit', (e) => {
      e.preventDefault();

      const invoiceCost = parseFloat(document.getElementById('invoiceCost').value) || 0;
      const markup = parseFloat(document.getElementById('markup').value) / 100 || 0.10;
      const holdback = parseFloat(document.getElementById('holdback').value) || 0;
      const incentives = parseFloat(document.getElementById('incentives').value) || 0;
      const salePrice = Math.round(invoiceCost * (1 + markup));

      const vehicle = {
        id: Utils.generateId('VEH'),
        vin: document.getElementById('vin').value || DB.generateVIN(),
        year: parseInt(document.getElementById('year').value),
        make: document.getElementById('make').value,
        model: document.getElementById('model').value,
        trim: document.getElementById('trim').value || 'Base',
        bodyStyle: document.getElementById('bodyStyle').value,
        condition: document.getElementById('condition').value,
        mileage: parseInt(document.getElementById('mileage').value) || 0,
        exteriorColor: document.getElementById('exteriorColor').value || 'White',
        interiorColor: document.getElementById('interiorColor').value || 'Black',
        specs: {
          engine: document.getElementById('engine').value || '2.5L I4',
          transmission: document.getElementById('transmission').value,
          drivetrain: document.getElementById('drivetrain').value,
          fuelType: document.getElementById('fuelType').value,
          horsepower: parseInt(document.getElementById('horsepower').value) || 200,
          torque: Math.round((parseInt(document.getElementById('horsepower').value) || 200) * 0.9),
          mpgCity: parseInt(document.getElementById('mpgCity').value) || 25,
          mpgHighway: parseInt(document.getElementById('mpgHighway').value) || 32,
          seating: 5
        },
        pricing: {
          invoiceCost,
          msrp: parseFloat(document.getElementById('msrp').value) || Math.round(invoiceCost * 1.15),
          minMarkup: 0.05,
          maxMarkup: 0.20,
          currentMarkup: markup,
          holdback,
          incentives,
          salePrice,
          netCost: invoiceCost - holdback - incentives
        },
        features: document.getElementById('features').value.split(',').map(f => f.trim()).filter(Boolean),
        images: [],
        status: 'Available',
        location: 'Main Lot - New Arrivals',
        addedDate: new Date().toISOString().split('T')[0],
        lastUpdated: new Date().toISOString().split('T')[0],
        assignedAgent: dealer?.id,
        views: 0,
        inquiries: 0,
        accidents: 0,
        owners: document.getElementById('condition').value === 'New' ? 0 : 1
      };

      DB.addVehicle(vehicle);
      Utils.showToast('Vehicle added successfully!', 'success');
      setTimeout(() => window.location.href = 'inventory.html', 1500);
    });
  </script>
</body>
</html>
