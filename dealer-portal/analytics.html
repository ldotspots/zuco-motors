<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytics - Zuco Motors Dealer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css">
  <style>
    .bar-chart { display: flex; align-items: flex-end; gap: 0.5rem; height: 200px; padding: 1rem 0; }
    .bar { flex: 1; background: var(--primary-600); border-radius: var(--radius-sm) var(--radius-sm) 0 0; position: relative; min-height: 4px; transition: all 0.3s; }
    .bar:hover { background: var(--primary-700); }
    .bar-label { position: absolute; bottom: -24px; left: 50%; transform: translateX(-50%); font-size: var(--text-xs); color: var(--gray-600); white-space: nowrap; }
    .bar-value { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: var(--text-xs); font-weight: 600; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <a href="index.html" class="logo"><img src="../css/images/zmnz (1).png" alt="ZMNZ Motors" style="height: 40px;"></a>
        <nav class="nav">
          <a href="index.html">Dashboard</a>
          <a href="inventory.html">Inventory</a>
          <a href="leads.html">Leads</a>
          <a href="pricing.html">Pricing</a>
          <a href="sales-orders.html">Sales Orders</a>
          <a href="quote-requests.html">Quote Requests</a>
          <a href="customers.html">Customers</a>
          <a href="analytics.html" class="active">Analytics</a>
          <a href="past-sales.html">Past Sales</a>
          <a href="profile.html">Profile</a>
          <button class="btn btn-secondary btn-sm" onclick="Auth.logout()">Logout</button>
        </nav>
      </div>
    </div>
  </header>

  <main class="section">
    <div class="container">
      <h1 class="mb-8">Analytics & Reports</h1>

      <!-- Top KPIs -->
      <div class="grid grid-4 mb-8">
        <div class="stat-card">
          <div class="stat-value" id="totalUnits">0</div>
          <div class="stat-label">Total Units Sold</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalRevenue">$0</div>
          <div class="stat-label">Total Sale Revenue</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="companyProfit" style="color:var(--success);">$0</div>
          <div class="stat-label">Company Profit</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="agentPayouts">$0</div>
          <div class="stat-label">Agent Payouts</div>
        </div>
      </div>

      <!-- Total Sales Breakdown -->
      <div class="card mb-8">
        <div class="card-header"><h3>Sales Breakdown</h3></div>
        <div class="card-body">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Vehicle</th>
                  <th>Agent</th>
                  <th style="text-align:right;">Sale Price</th>
                  <th style="text-align:right;">Invoice Cost</th>
                  <th style="text-align:right;">Gross Spread</th>
                  <th id="companyColHeader" style="text-align:right;">Company</th>
                  <th id="agentColHeader" style="text-align:right;">Agent</th>
                </tr>
              </thead>
              <tbody id="salesBreakdown"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="card mb-8">
        <div class="card-header"><h3>Monthly Sales</h3></div>
        <div class="card-body">
          <div id="monthlySalesChart" class="bar-chart" style="margin-bottom: 2rem;"></div>
        </div>
      </div>

      <!-- Agent Sales Performance -->
      <div class="card mb-8">
        <div class="card-header"><h3>Sales Agent Performance</h3></div>
        <div class="card-body">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Agent</th>
                  <th>Completed Sales</th>
                  <th>Total Revenue</th>
                  <th>Company Revenue</th>
                  <th>Agent Profit</th>
                </tr>
              </thead>
              <tbody id="agentPerformance"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- More Analytics -->
      <div class="grid grid-2 mb-8">
        <!-- Top Vehicles by Views -->
        <div class="card">
          <div class="card-header"><h3>Top Vehicles by Views</h3></div>
          <div class="card-body">
            <div id="topVehicles"></div>
          </div>
        </div>

        <!-- Inquiry Types -->
        <div class="card">
          <div class="card-header"><h3>Inquiry Breakdown</h3></div>
          <div class="card-body">
            <div id="inquiryTypes"></div>
          </div>
        </div>
      </div>

      <!-- Inventory Breakdown -->
      <div class="card">
        <div class="card-header"><h3>Inventory by Condition</h3></div>
        <div class="card-body">
          <div id="inventoryBreakdown" class="grid grid-3"></div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <div class="footer-bottom">
        <p>&copy; 2024 Zuco Motors. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script src="../js/db.js"></script>
  <script src="../js/auth.js"></script>
  <script src="../js/utils.js"></script>
  <script>
    const dealer = Auth.getCurrentUser();
    const transactions = DB.getTransactionsByAgent(dealer?.id) || [];
    const leads = DB.getInquiries() || [];
    const vehicles = DB.getVehicles();
    const agentSales = DB.getAgentSales().filter(s => s.status === 'completed');

    // Compute totals from agent sales
    let totalSaleRevenue = 0;
    let totalGrossSpread = 0;
    let totalCompanyMargin = 0;
    let totalAgentProfit = 0;
    let totalInvoiceCost = 0;

    agentSales.forEach(s => {
      const v = DB.getVehicle(s.vehicleId);
      const invoiceCost = v ? v.pricing.invoiceCost : 0;
      const grossSpread = s.salePrice - invoiceCost;
      const companyMargin = Math.round(grossSpread * DB.COMPANY_MARGIN_RATE);
      totalSaleRevenue += s.salePrice;
      totalInvoiceCost += invoiceCost;
      totalGrossSpread += grossSpread;
      totalCompanyMargin += companyMargin;
      totalAgentProfit += s.agentProfit;
    });

    const totalUnits = agentSales.length;

    // KPIs
    document.getElementById('totalUnits').textContent = totalUnits;
    document.getElementById('totalRevenue').textContent = Utils.formatCurrency(totalSaleRevenue);
    document.getElementById('companyProfit').textContent = Utils.formatCurrency(totalCompanyMargin);
    document.getElementById('agentPayouts').textContent = Utils.formatCurrency(totalAgentProfit);

    // Sales Breakdown Table — individual vehicle rows
    document.getElementById('companyColHeader').textContent = `Company (${(DB.COMPANY_MARGIN_RATE * 100).toFixed(0)}%)`;
    document.getElementById('agentColHeader').textContent = `Agent (${(100 - DB.COMPANY_MARGIN_RATE * 100).toFixed(0)}%)`;
    // Agent sale rows
    let breakdownRows = agentSales.map(s => {
      const v = DB.getVehicle(s.vehicleId);
      const invoiceCost = v ? v.pricing.invoiceCost : 0;
      const grossSpread = s.salePrice - invoiceCost;
      const companyMargin = Math.round(grossSpread * DB.COMPANY_MARGIN_RATE);
      return `<tr>
        <td style="padding:0.75rem;">${Utils.formatDate(s.completedAt || s.saleDate)}</td>
        <td style="padding:0.75rem;">${v ? `${v.year} ${v.make} ${v.model}` : 'Unknown'}</td>
        <td style="padding:0.75rem;">${s.agentName || 'N/A'}</td>
        <td style="padding:0.75rem;text-align:right;">${Utils.formatCurrency(s.salePrice)}</td>
        <td style="padding:0.75rem;text-align:right;">${Utils.formatCurrency(invoiceCost)}</td>
        <td style="padding:0.75rem;text-align:right;">${Utils.formatCurrency(grossSpread)}</td>
        <td style="padding:0.75rem;text-align:right;color:var(--success);font-weight:600;">${Utils.formatCurrency(companyMargin)}</td>
        <td style="padding:0.75rem;text-align:right;">${Utils.formatCurrency(s.agentProfit)}</td>
      </tr>`;
    }).join('');

    // Add totals row
    breakdownRows += `<tr style="border-top:2px solid var(--gray-400);font-weight:700;">
      <td style="padding:0.75rem;"></td>
      <td style="padding:0.75rem;">Totals (${totalUnits} sales)</td>
      <td style="padding:0.75rem;"></td>
      <td style="padding:0.75rem;text-align:right;">${Utils.formatCurrency(totalSaleRevenue)}</td>
      <td style="padding:0.75rem;text-align:right;">${Utils.formatCurrency(totalInvoiceCost)}</td>
      <td style="padding:0.75rem;text-align:right;">${Utils.formatCurrency(totalGrossSpread)}</td>
      <td style="padding:0.75rem;text-align:right;color:var(--success);">${Utils.formatCurrency(totalCompanyMargin)}</td>
      <td style="padding:0.75rem;text-align:right;">${Utils.formatCurrency(totalAgentProfit)}</td>
    </tr>`;

    document.getElementById('salesBreakdown').innerHTML = breakdownRows || '<tr><td colspan="8" style="text-align:center;padding:2rem;color:var(--gray-500);">No completed sales yet</td></tr>';

    // Monthly Sales Chart — all 12 months
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const monthlySales = months.map((_, i) => {
      return agentSales.filter(s => {
        const d = s.completedAt ? new Date(s.completedAt) : new Date(s.saleDate);
        return d.getMonth() === i;
      }).length;
    });
    const maxSales = Math.max(...monthlySales, 1);
    document.getElementById('monthlySalesChart').innerHTML = months.map((m, i) => {
      const height = (monthlySales[i] / maxSales * 100);
      return `<div class="bar" style="height: ${Math.max(height, 2)}%;">
        <span class="bar-value">${monthlySales[i]}</span>
        <span class="bar-label">${m}</span>
      </div>`;
    }).join('');

    // Top Vehicles
    const topVehicles = vehicles.filter(v => v.status === 'Available').sort((a, b) => b.views - a.views).slice(0, 5);
    document.getElementById('topVehicles').innerHTML = topVehicles.map((v, i) => `
      <div style="display:flex;justify-content:space-between;align-items:center;padding:0.75rem 0;${i < topVehicles.length - 1 ? 'border-bottom:1px solid var(--gray-200);' : ''}">
        <div>
          <strong>${v.year} ${v.make} ${v.model}</strong>
          <span style="font-size:var(--text-sm);color:var(--gray-600);margin-left:0.5rem;">${Utils.formatCurrency(v.pricing.salePrice)}</span>
        </div>
        <span class="badge badge-primary">${v.views} views</span>
      </div>
    `).join('') || '<p style="color:var(--gray-600);">No data</p>';

    // Inquiry Types
    const types = ['purchase', 'trade-in', 'financing', 'test-drive'];
    document.getElementById('inquiryTypes').innerHTML = types.map(t => {
      const count = leads.filter(l => l.type === t).length;
      const pct = leads.length ? (count / leads.length * 100).toFixed(0) : 0;
      return `<div style="display:flex;justify-content:space-between;align-items:center;padding:0.75rem 0;border-bottom:1px solid var(--gray-200);">
        <span style="text-transform:capitalize;">${t}</span>
        <div><strong>${count}</strong> <span style="color:var(--gray-500);">(${pct}%)</span></div>
      </div>`;
    }).join('');

    // Inventory Breakdown
    const conditions = ['New', 'Certified Pre-Owned', 'Used'];
    document.getElementById('inventoryBreakdown').innerHTML = conditions.map(c => {
      const count = vehicles.filter(v => v.condition === c && v.status === 'Available').length;
      const value = vehicles.filter(v => v.condition === c && v.status === 'Available').reduce((s, v) => s + v.pricing.salePrice, 0);
      return `<div class="stat-card text-center">
        <div class="stat-value">${count}</div>
        <div class="stat-label">${c}</div>
        <div style="color:var(--gray-600);font-size:var(--text-sm);margin-top:0.5rem;">${Utils.formatCurrency(value)} total value</div>
      </div>`;
    }).join('');

    // Agent Performance Table
    const agentMap = {};
    agentSales.forEach(s => {
      if (!agentMap[s.agentId]) agentMap[s.agentId] = { name: s.agentName, sales: 0, revenue: 0, companyRev: 0, agentProfit: 0 };
      const entry = agentMap[s.agentId];
      entry.sales++;
      entry.revenue += s.salePrice;
      entry.agentProfit += s.agentProfit;
      const v = DB.getVehicle(s.vehicleId);
      if (v) entry.companyRev += Math.round((s.salePrice - v.pricing.invoiceCost) * DB.COMPANY_MARGIN_RATE);
    });
    const agentRows = Object.values(agentMap).sort((a, b) => b.revenue - a.revenue);
    document.getElementById('agentPerformance').innerHTML = agentRows.map(a => `
      <tr>
        <td><strong>${a.name}</strong></td>
        <td>${a.sales}</td>
        <td>${Utils.formatCurrency(a.revenue)}</td>
        <td style="color:var(--success);font-weight:600;">${Utils.formatCurrency(a.companyRev)}</td>
        <td>${Utils.formatCurrency(a.agentProfit)}</td>
      </tr>
    `).join('') || '<tr><td colspan="5" style="text-align:center;padding:2rem;color:var(--gray-500);">No completed agent sales yet</td></tr>';
  </script>
</body>
</html>
