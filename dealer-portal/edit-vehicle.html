<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Vehicle - Zuco Motors Dealer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <a href="index.html" class="logo"><img src="../css/images/zmnz (1).png" alt="ZMNZ Motors" style="height: 40px;"></a>
        <nav class="nav">
          <a href="index.html">Dashboard</a>
          <a href="inventory.html">Inventory</a>
          <a href="leads.html">Leads</a>
          <a href="pricing.html">Pricing</a>
          <a href="sales-orders.html">Sales Orders</a>
          <a href="quote-requests.html">Quote Requests</a>
          <a href="customers.html">Customers</a>
          <a href="applications.html">Applications</a>
          <a href="financing-applications.html">Financing</a>
          <a href="analytics.html">Analytics</a>
          <a href="past-sales.html">Past Sales</a>
          <a href="profile.html">Profile</a>
          <button class="btn btn-secondary btn-sm" onclick="Auth.logout()">Logout</button>
        </nav>
      </div>
    </div>
  </header>

  <main class="section">
    <div class="container" style="max-width: 900px;">
      <div class="flex justify-between items-center mb-8">
        <h1>Edit Vehicle</h1>
        <a href="inventory.html" class="btn btn-secondary">Back to Inventory</a>
      </div>

      <div id="vehicleNotFound" style="display:none;text-align:center;padding:4rem;">
        <h2>Vehicle Not Found</h2>
        <p style="color:var(--gray-600);margin:1rem 0;">The vehicle you're looking for doesn't exist.</p>
        <a href="inventory.html" class="btn btn-primary">Back to Inventory</a>
      </div>

      <form id="editVehicleForm" style="display:none;">
        <!-- Basic Info -->
        <div class="card mb-6">
          <div class="card-header"><h3>Vehicle Information</h3></div>
          <div class="card-body">
            <div class="grid grid-3">
              <div class="form-group">
                <label for="year">Year *</label>
                <input type="number" id="year" class="form-control" required min="1990" max="2025">
              </div>
              <div class="form-group">
                <label for="make">Make *</label>
                <input type="text" id="make" class="form-control" required>
              </div>
              <div class="form-group">
                <label for="model">Model *</label>
                <input type="text" id="model" class="form-control" required>
              </div>
            </div>
            <div class="grid grid-3">
              <div class="form-group">
                <label for="trim">Trim</label>
                <input type="text" id="trim" class="form-control">
              </div>
              <div class="form-group">
                <label for="bodyStyle">Body Style *</label>
                <select id="bodyStyle" class="form-control" required>
                  <option value="Sedan">Sedan</option>
                  <option value="SUV">SUV</option>
                  <option value="Truck">Truck</option>
                  <option value="Coupe">Coupe</option>
                  <option value="Hatchback">Hatchback</option>
                  <option value="Minivan">Minivan</option>
                  <option value="Wagon">Wagon</option>
                  <option value="Ute">Ute</option>
                </select>
              </div>
              <div class="form-group">
                <label for="condition">Condition *</label>
                <select id="condition" class="form-control" required>
                  <option value="New">New</option>
                  <option value="Certified Pre-Owned">Certified Pre-Owned</option>
                  <option value="Used">Used</option>
                </select>
              </div>
            </div>
            <div class="grid grid-2">
              <div class="form-group">
                <label for="vin">VIN</label>
                <input type="text" id="vin" class="form-control" maxlength="17">
              </div>
              <div class="form-group">
                <label for="mileage">Mileage (km) *</label>
                <input type="number" id="mileage" class="form-control" required min="0">
              </div>
            </div>
            <div class="grid grid-2">
              <div class="form-group">
                <label for="exteriorColor">Exterior Color</label>
                <input type="text" id="exteriorColor" class="form-control">
              </div>
              <div class="form-group">
                <label for="interiorColor">Interior Color</label>
                <input type="text" id="interiorColor" class="form-control">
              </div>
            </div>
          </div>
        </div>

        <!-- Specs -->
        <div class="card mb-6">
          <div class="card-header"><h3>Specifications</h3></div>
          <div class="card-body">
            <div class="grid grid-3">
              <div class="form-group">
                <label for="engine">Engine</label>
                <input type="text" id="engine" class="form-control">
              </div>
              <div class="form-group">
                <label for="transmission">Transmission</label>
                <select id="transmission" class="form-control">
                  <option value="Automatic">Automatic</option>
                  <option value="Manual">Manual</option>
                  <option value="CVT">CVT</option>
                  <option value="DSG">DSG</option>
                  <option value="Single-Speed">Single-Speed (EV)</option>
                </select>
              </div>
              <div class="form-group">
                <label for="drivetrain">Drivetrain</label>
                <select id="drivetrain" class="form-control">
                  <option value="FWD">FWD</option>
                  <option value="RWD">RWD</option>
                  <option value="AWD">AWD</option>
                  <option value="4WD">4WD</option>
                </select>
              </div>
            </div>
            <div class="grid grid-4">
              <div class="form-group">
                <label for="fuelType">Fuel Type</label>
                <select id="fuelType" class="form-control">
                  <option value="Gasoline">Petrol</option>
                  <option value="Diesel">Diesel</option>
                  <option value="Electric">Electric</option>
                  <option value="Hybrid">Hybrid</option>
                </select>
              </div>
              <div class="form-group">
                <label for="horsepower">Horsepower</label>
                <input type="number" id="horsepower" class="form-control" min="0">
              </div>
              <div class="form-group">
                <label for="mpgCity">MPG City</label>
                <input type="number" id="mpgCity" class="form-control" min="0">
              </div>
              <div class="form-group">
                <label for="mpgHighway">MPG Highway</label>
                <input type="number" id="mpgHighway" class="form-control" min="0">
              </div>
            </div>
          </div>
        </div>

        <!-- Pricing -->
        <div class="card mb-6">
          <div class="card-header"><h3>Pricing</h3></div>
          <div class="card-body">
            <div class="grid grid-2">
              <div class="form-group">
                <label for="costPrice">Cost Price ($) *</label>
                <input type="number" id="costPrice" class="form-control" required min="0" step="100" oninput="updateListingPrice()">
              </div>
              <div class="form-group">
                <label for="listingPrice">Listing Price ($)</label>
                <input type="number" id="listingPrice" class="form-control" min="0" step="100" oninput="updateProfitDisplay()">
              </div>
            </div>
            <div class="form-group">
              <label for="markup">Markup: <span id="markupDisplay">10%</span></label>
              <input type="range" id="markup" class="form-control" min="0" max="30" step="1" value="10" style="padding:0;" oninput="updateListingPrice()">
              <div style="display:flex;justify-content:space-between;font-size:var(--text-xs);color:var(--gray-500);margin-top:0.25rem;">
                <span>0%</span>
                <span>15%</span>
                <span>30%</span>
              </div>
            </div>
            <div id="profitSummary" style="background:var(--gray-50);padding:1rem;border-radius:var(--radius-md);margin-top:1rem;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem;">
                <span style="color:var(--gray-600);">Total Profit:</span>
                <span id="profitAmount" style="font-size:var(--text-xl);font-weight:700;color:var(--success);">$0</span>
              </div>
              <div style="display:flex;justify-content:space-between;align-items:center;padding-top:0.75rem;border-top:1px solid var(--gray-200);">
                <span style="color:var(--gray-500);font-size:var(--text-sm);">Company (89%):</span>
                <span id="companyProfit" style="font-weight:600;color:var(--gray-700);">$0</span>
              </div>
              <div style="display:flex;justify-content:space-between;align-items:center;margin-top:0.25rem;">
                <span style="color:var(--gray-500);font-size:var(--text-sm);">Agent Commission (11%):</span>
                <span id="agentProfit" style="font-weight:600;color:var(--primary-600);">$0</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Photos -->
        <div class="card mb-6">
          <div class="card-header"><h3>Photos</h3></div>
          <div class="card-body">
            <div id="existingPhotos" style="margin-bottom:1rem;"></div>
            <div class="form-group">
              <label for="photos">Add More Photos</label>
              <input type="file" id="photos" class="form-control" multiple accept="image/jpeg,image/png,image/webp" onchange="handlePhotoUpload(event)" style="padding:0.5rem;">
              <p style="font-size:var(--text-xs);color:var(--gray-500);margin-top:0.25rem;">Accepts JPG, PNG, WebP. Max 20 photos total. First photo will be the main image.</p>
            </div>
            <div id="photoPreview" style="display:flex;flex-wrap:wrap;gap:0.75rem;margin-top:1rem;"></div>
          </div>
        </div>

        <!-- Features -->
        <div class="card mb-6">
          <div class="card-header"><h3>Features</h3></div>
          <div class="card-body">
            <div class="form-group">
              <label for="features">Features (comma-separated)</label>
              <textarea id="features" class="form-control" rows="3"></textarea>
            </div>
          </div>
        </div>

        <div class="flex gap-4">
          <button type="submit" class="btn btn-primary btn-lg">Save Changes</button>
          <a href="inventory.html" class="btn btn-secondary btn-lg">Cancel</a>
        </div>
      </form>
    </div>
  </main>

  <footer>
    <div class="container">
      <div class="footer-bottom">
        <p>&copy; 2024 Zuco Motors. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script src="../js/supabase-config.js"></script>
  <script src="../js/db.js"></script>
  <script src="../js/auth.js"></script>
  <script src="../js/utils.js"></script>
  <script>
    const dealer = Auth.getCurrentUserSync();
    const params = new URLSearchParams(window.location.search);
    const vehicleId = params.get('id');

    let vehicle = null;
    let uploadedPhotos = [];

    // Load vehicle data
    async function init() {
      if (!vehicleId) {
        document.getElementById('vehicleNotFound').style.display = 'block';
        return;
      }

      vehicle = await DB.getVehicle(vehicleId);
      if (!vehicle) {
        document.getElementById('vehicleNotFound').style.display = 'block';
        return;
      }

      document.getElementById('editVehicleForm').style.display = 'block';
      populateForm();
    }

    function populateForm() {
      // Basic info
      document.getElementById('year').value = vehicle.year || '';
      document.getElementById('make').value = vehicle.make || '';
      document.getElementById('model').value = vehicle.model || '';
      document.getElementById('trim').value = vehicle.trim || '';
      document.getElementById('bodyStyle').value = vehicle.bodyStyle || 'Sedan';
      document.getElementById('condition').value = vehicle.condition || 'Used';
      document.getElementById('vin').value = vehicle.vin || '';
      document.getElementById('mileage').value = vehicle.mileage || 0;
      document.getElementById('exteriorColor').value = vehicle.exteriorColor || '';
      document.getElementById('interiorColor').value = vehicle.interiorColor || '';

      // Specs
      document.getElementById('engine').value = vehicle.specs?.engine || '';
      document.getElementById('transmission').value = vehicle.specs?.transmission || 'Automatic';
      document.getElementById('drivetrain').value = vehicle.specs?.drivetrain || 'FWD';
      document.getElementById('fuelType').value = vehicle.specs?.fuelType || 'Gasoline';
      document.getElementById('horsepower').value = vehicle.specs?.horsepower || '';
      document.getElementById('mpgCity').value = vehicle.specs?.mpgCity || '';
      document.getElementById('mpgHighway').value = vehicle.specs?.mpgHighway || '';

      // Pricing
      document.getElementById('costPrice').value = vehicle.pricing?.invoiceCost || '';
      document.getElementById('listingPrice').value = vehicle.pricing?.salePrice || '';
      const markup = vehicle.pricing?.currentMarkup ? Math.round(vehicle.pricing.currentMarkup * 100) : 10;
      document.getElementById('markup').value = markup;
      document.getElementById('markupDisplay').textContent = markup + '%';
      updateProfitDisplay();

      // Features
      document.getElementById('features').value = (vehicle.features || []).join(', ');

      // Photos - load existing ones
      uploadedPhotos = (vehicle.images || []).filter(img => img && img.startsWith('data:'));
      renderAllPhotos();
    }

    function renderAllPhotos() {
      const container = document.getElementById('photoPreview');
      if (uploadedPhotos.length === 0) {
        container.innerHTML = '<p style="color:var(--gray-500);font-size:var(--text-sm);">No photos yet. Upload some above.</p>';
        return;
      }

      container.innerHTML = uploadedPhotos.map((photo, idx) => `
        <div style="position:relative;width:120px;height:90px;border-radius:var(--radius-md);overflow:hidden;border:2px solid ${idx === 0 ? 'var(--primary-500)' : 'var(--gray-200)'};">
          <img src="${photo}" style="width:100%;height:100%;object-fit:cover;">
          ${idx === 0 ? '<span style="position:absolute;bottom:0;left:0;right:0;background:var(--primary-500);color:white;font-size:10px;text-align:center;padding:2px;">Main Photo</span>' : ''}
          <button type="button" onclick="removePhoto(${idx})" style="position:absolute;top:4px;right:4px;background:#dc2626;color:white;border:none;border-radius:50%;width:20px;height:20px;font-size:12px;cursor:pointer;line-height:1;">&times;</button>
        </div>
      `).join('');
    }

    function handlePhotoUpload(event) {
      const files = Array.from(event.target.files);
      const maxPhotos = 20;
      const maxSize = 2 * 1024 * 1024;

      if (uploadedPhotos.length + files.length > maxPhotos) {
        Utils.showToast(`Maximum ${maxPhotos} photos allowed`, 'error');
        return;
      }

      files.forEach(file => {
        if (file.size > maxSize) {
          Utils.showToast(`${file.name} is too large. Max 2MB per image.`, 'error');
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          resizeImage(e.target.result, 800, 600, (resizedDataUrl) => {
            uploadedPhotos.push(resizedDataUrl);
            renderAllPhotos();
          });
        };
        reader.readAsDataURL(file);
      });
    }

    function resizeImage(dataUrl, maxWidth, maxHeight, callback) {
      const img = new Image();
      img.onload = () => {
        let width = img.width;
        let height = img.height;

        if (width > maxWidth) {
          height = (height * maxWidth) / width;
          width = maxWidth;
        }
        if (height > maxHeight) {
          width = (width * maxHeight) / height;
          height = maxHeight;
        }

        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        callback(canvas.toDataURL('image/jpeg', 0.8));
      };
      img.src = dataUrl;
    }

    function removePhoto(idx) {
      uploadedPhotos.splice(idx, 1);
      renderAllPhotos();
    }

    function updateListingPrice() {
      const costPrice = parseFloat(document.getElementById('costPrice').value) || 0;
      const markup = parseFloat(document.getElementById('markup').value) || 10;
      const listingPrice = Math.round(costPrice * (1 + markup / 100));

      document.getElementById('markupDisplay').textContent = markup + '%';
      document.getElementById('listingPrice').value = listingPrice || '';
      updateProfitDisplay();
    }

    function updateProfitDisplay() {
      const costPrice = parseFloat(document.getElementById('costPrice').value) || 0;
      const listingPrice = parseFloat(document.getElementById('listingPrice').value) || 0;
      const profit = listingPrice - costPrice;

      const companyProfit = Math.round(profit * 0.89);
      const agentProfit = Math.round(profit * 0.11);

      document.getElementById('profitAmount').textContent = Utils.formatCurrency(profit);
      document.getElementById('profitAmount').style.color = profit >= 0 ? 'var(--success)' : 'var(--error)';
      document.getElementById('companyProfit').textContent = Utils.formatCurrency(companyProfit);
      document.getElementById('agentProfit').textContent = Utils.formatCurrency(agentProfit);
    }

    document.getElementById('editVehicleForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const costPrice = parseFloat(document.getElementById('costPrice').value) || 0;
      const listingPrice = parseFloat(document.getElementById('listingPrice').value) || 0;
      const markup = listingPrice > 0 && costPrice > 0 ? (listingPrice - costPrice) / costPrice : 0.10;

      const updates = {
        year: parseInt(document.getElementById('year').value),
        make: document.getElementById('make').value,
        model: document.getElementById('model').value,
        trim: document.getElementById('trim').value || 'Base',
        bodyStyle: document.getElementById('bodyStyle').value,
        condition: document.getElementById('condition').value,
        vin: document.getElementById('vin').value,
        mileage: parseInt(document.getElementById('mileage').value) || 0,
        exteriorColor: document.getElementById('exteriorColor').value || 'White',
        interiorColor: document.getElementById('interiorColor').value || 'Black',
        specs: {
          engine: document.getElementById('engine').value || '2.5L I4',
          transmission: document.getElementById('transmission').value,
          drivetrain: document.getElementById('drivetrain').value,
          fuelType: document.getElementById('fuelType').value,
          horsepower: parseInt(document.getElementById('horsepower').value) || 200,
          torque: Math.round((parseInt(document.getElementById('horsepower').value) || 200) * 0.9),
          mpgCity: parseInt(document.getElementById('mpgCity').value) || 25,
          mpgHighway: parseInt(document.getElementById('mpgHighway').value) || 32,
          seating: vehicle.specs?.seating || 5
        },
        pricing: {
          ...vehicle.pricing,
          invoiceCost: costPrice,
          msrp: listingPrice,
          currentMarkup: markup,
          salePrice: listingPrice,
          netCost: costPrice
        },
        features: document.getElementById('features').value.split(',').map(f => f.trim()).filter(Boolean),
        images: uploadedPhotos,
        lastUpdated: new Date().toISOString().split('T')[0]
      };

      await DB.updateVehicle(vehicleId, updates);
      Utils.showToast('Vehicle updated successfully!', 'success');
      setTimeout(() => window.location.href = 'inventory.html', 1500);
    });

    init();
  </script>
</body>
</html>
